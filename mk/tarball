#! /usr/bin/env sh

project="squash_dir"
mkclean="./mk/clean"
mkemerge="./mk/emerge"
mkrelease="./mk/release"
mkmake="./mk/make"
mkmakeextra=
make_opts='-q'

export LC_ALL XZ_OPT
LC_ALL=C
XZ_OPT='--extreme'

Echo() {
	printf '%s\n' "${*}"
}

Usage() {
	Echo "Usage: ${0##*/} [options] [xz|lzma|bzip2|gzip|default]
options: -fakeroot, -fakeroot-ng, -no-fakeroot (default is -${fakeroot})"
	exit ${1:-1}
}

Die() {
	printf '%s: %s\n' "${0##*/}" "${1}"
	exit ${2:-1}
}

Run() {
	Echo "${*}"
	"${@}" || Die "${*} failed" ${?}
}

dist='dist-gzip'
fakeroot=
[ -z "${fakeroot}" ] && command -v fakeroot >/dev/null 2>&1 && fakeroot='fakeroot'
[ -z "${fakeroot}" ] && command -v fakeroot-ng >/dev/null 2>&1 && fakeroot='fakeroot-ng'

while [ ${#} -gt 0 ]
do	opt=${1#-}
	opt=${opt#-}
	case ${opt#dist-} in
	[xX]*)
		dist='dist-xz';;
	[lL]*)
		dist='dist-lzma';;
	[bB]*)
		dist='dist-bzip2';;
	[gG]*)
		dist='dist-gzip';;
	[dD]*)
		dist='dist';;
	f*ng)
		fakeroot='fakeroot-ng';;
	f*)
		fakeroot='fakeroot';;
	F*|n*f*)
		fakeroot=;;
	[hH?]*)
		Usage 0;;
	*)
		Usage;;
	esac
	shift
done
[ -z "${dist}" ] && Usage

if [ -n "${mkclean}" ]
then test -e Makefile || test -e configure || test -e Makefile.in \
	&& test -e "${mkclean}" && Run "${mkclean}"
fi

unset LDFLAGS CFLAGS CXXFLAGS CPPFLAGS
if [ -n "${fakeroot}" ] && command -v "${fakeroot}" >/dev/null 2>&1
then	Run ${mkmake} ${make_opts}n
	docmd="${fakeroot} ${mkmake} ${make_opts}r"
else	docmd="${mkmake} ${make_opts}"
fi
for i in ${dist}
do	Run ${docmd} ${mkmakeextra} "${i}"
done

found=false
for j in tar.xz tar.lzma tar.bz2 tar.gz zip tar.Z shar.gz shar
do	for i in "${PWD}/${project}"-*".${j}"
	do	test -f "${i}" || continue
		${found} || Echo "Available tarballs:"
		found=:
		printf '\t%s\n' "${i}"
	done
done
${found} || Die "For some reason no tarball was created"
[ -n "${mkclean}" ] && Echo "The tarballs will be removed with ${mkclean}"
[ -n "${mkemerge}" ] && Echo "To install with portage run as root ${mkemerge}"
[ -n "${mkrelease}" ] && \
	Echo "To tag the release in git you should run ${mkrelease}"
exit 0
